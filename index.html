<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SifunaStena</title>
  <style>
    body {
      font-family: system-ui;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background: #121212;
      color: white;
    }
    #app {
      text-align: center;
      width: 100%;
      max-width: 400px;
      padding: 2em;
    }
    h1 {
      font-size: 5em;
      color: gold;
    }
    input, button {
      font-family: system-ui;
      margin: 0.4em 0;
      padding: 0.6em;
      width: 100%;
      box-sizing: border-box;
      font-size: 1em;
    }
    button {
      background: navy;
      color: white;
      border: none;
      cursor: pointer;
    }
    .tx-log {
      text-align: left;
      margin-top: 1em;
      max-height: 200px;
      overflow-y: auto;
      border-top: 1px solid #444;
      padding-top: 1em;
    }
    .tx-entry {
      font-size: 0.9em;
      margin-bottom: 0.5em;
    }
    #balance {
      font-size: 2.5em;
      margin: 0.2em 0;
      transition: transform 0.2s ease;
      color: gold;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="login-view">
      <h1>Ϡ</h1>
      <h3>Log In</h3>
      <input id="email" placeholder="Email" />
      <input id="password" type="password" placeholder="Password" />
      <button onclick="login()">Log In</button>
      <button onclick="signup()">Sign Up</button>
      <p id="login-message"></p>
    </div>

    <div id="main-view" style="display: none;">
      <h1>Ϡ</h1>
      <div id="balance">Ϡ0</div>
      <p id="user-name"></p>

      <input id="to" placeholder="Send to (email)" />
      <input id="amount" type="number" placeholder="Amount" />
      <input id="message" placeholder="Message (optional)" />
      <button onclick="send()">Send</button>

      <div class="tx-log" id="tx-log"></div>
    </div>
  </div>

  <script>
    let email = localStorage.getItem("username") || "";
    let socket;

    function show(view) {
      document.getElementById("login-view").style.display = view === "login" ? "" : "none";
      document.getElementById("main-view").style.display = view === "main" ? "" : "none";
    }

    async function login() {
      const emailInput = document.getElementById("email").value;
      const pw = document.getElementById("password").value;
      const res = await fetch("/login", {
        method: "POST",
        body: JSON.stringify({ email: emailInput, password: pw }),
      });

      if (!res.ok) {
        document.getElementById("login-message").innerText = "Login failed or unapproved.";
        return;
      }

      const data = await res.json();
      email = emailInput;
      localStorage.setItem("username", email);
      document.getElementById("user-name").innerText = data.name;
      updateBalance(data.balance);
      loadTx();
      wsConnect();
      show("main");
    }

    async function send() {
      const to = document.getElementById("to").value;
      const amount = parseFloat(document.getElementById("amount").value);
      const message = document.getElementById("message").value;

      const res = await fetch("/send", {
        method: "POST",
        body: JSON.stringify({ from: email, to, amount, message }),
      });

      if (res.ok) {
        loadTx();
      }
    }

    async function signup() {
      const emailInput = document.getElementById("email").value;
      const pw = document.getElementById("password").value;
      const payload = {
        name: "Test",
        surname: "User",
        email: emailInput,
        cell: "0000000000",
        password: pw,
        idb64: btoa("fake-id-placeholder")
      };

      const res = await fetch("/signup", {
        method: "POST",
        body: JSON.stringify(payload),
      });

      if (res.ok) {
        document.getElementById("login-message").innerText = "Signup submitted. Await approval.";
      }
    }

    async function loadTx() {
      const res = await fetch("/tx", {
        method: "POST",
        body: JSON.stringify({ email }),
      });
      const txs = await res.json();
      const log = document.getElementById("tx-log");
      log.innerHTML = txs.map(t =>
        `<div class="tx-entry">
          <b>${t.from}</b> → <b>${t.to}</b><br/>
          Ϡ${t.amount} - ${t.message || ""}<br/>
          <small>${new Date(t.time).toLocaleString()}</small>
        </div>`
      ).join("");
    }

    function updateBalance(amount) {
      const bal = document.getElementById("balance");
      bal.innerText = "Ϡ" + amount;
      bal.style.transform = "scale(1.2)";
      setTimeout(() => bal.style.transform = "scale(1)", 200);
    }

    function wsConnect() {
      socket = new WebSocket(`ws://${location.host}/ws?user=${email}`);
      socket.onmessage = async (e) => {
        if (e.data === "update") {
          const res = await fetch("/login", {
            method: "POST",
            body: JSON.stringify({ email, password: "" }),
          });
          if (res.ok) {
            const data = await res.json();
            updateBalance(data.balance);
            loadTx();
          }
        } else if (e.data === "approved") {
          document.getElementById("login-message").innerText = "You have been approved!";
        }
      };
    }

    if (email) {
      document.getElementById("email").value = email;
      show("login");
    } else {
      show("login");
    }
  </script>
</body>
</html>
